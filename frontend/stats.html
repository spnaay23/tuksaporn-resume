<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Stats</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .stats-container {
            max-width: 1000px;
            margin: 100px auto;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            background: var(--surface-color);
            border-radius: 10px;
            overflow: hidden;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        th {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-family: var(--font-heading);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .refresh-btn {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="cursor-dot" id="cursor-dot"></div>
    <div class="cursor-outline" id="cursor-outline"></div>

    <header class="header">
        <nav class="navbar">
            <a href="index.html" class="logo">TT<span class="accent">.</span></a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="#" class="active">Stats</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="stats-container">
            <h1 class="section-title fade-up">Visitor Statistics</h1>
            <p class="fade-up">Tracking recent visitors to the website.</p>

            <button onclick="fetchStats()" class="btn-primary refresh-btn fade-up">Refresh Data</button>

            <div class="table-responsive fade-up">
                <table id="stats-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>IP Address</th>
                            <th>User Agent</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        async function fetchStats() {
            const tbody = document.querySelector('#stats-table tbody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Loading data...</td></tr>';

            try {
                const response = await fetch('/api/stats');
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`Server returned ${response.status} ${response.statusText}: ${text.substring(0, 50)}...`);
                }
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                if (!data.recent_visits || data.recent_visits.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No visitors recorded yet.</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                data.recent_visits.forEach(visit => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${visit.id}</td>
                        <td>${visit.ip}</td>
                        <td>${visit.user_agent}</td>
                        <td>${new Date(visit.timestamp).toLocaleString()}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error fetching stats:', error);
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: #ff6b6b;">Error: ${error.message}<br>Make sure you are using a Web Service, not a Static Site.</td></tr>`;
            }
        }

        // Fetch on load
        document.addEventListener('DOMContentLoaded', fetchStats);
    </script>
</body>

</html>